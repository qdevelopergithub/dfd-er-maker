<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFD Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/docx@5.0.2/build/index.js"></script>
    <script>
        // Initialize docx library
        const { Document, Paragraph, Packer, HeadingLevel, AlignmentType } = docx;
    </script>
    <style>
        .preview-container {
            min-height: 300px;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: white;
        }
        .mermaid {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .preview-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
            font-style: italic;
        }
        .doc-section {
            margin-bottom: 1.5rem;
        }
        .doc-section h4 {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .doc-item {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        .chat-input {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            resize: none;
            transition: all 0.3s ease;
        }
        .chat-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .generate-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .generate-button:hover {
            background-color: #2563eb;
        }
        .generate-button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        .full-screen-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loader-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="fullScreenLoader" class="full-screen-loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="text-lg font-semibold">Generating Documentation...</div>
            <div class="text-sm text-gray-500 mt-2">Please wait while we prepare your document</div>
        </div>
    </div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">Data Flow Diagram Generator</h1>
            <p class="text-lg text-gray-600">Transform your system description into visual diagrams and detailed documentation</p>
        </header>

        <div class="grid grid-cols-1 gap-8">
            <!-- Input Section -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between w-100">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800 mt-4">
                            <i class="fas fa-pencil-alt mr-2"></i>System Description
                        </h2>
                    </div>
                    <!-- Diagram Type Selector -->
                    <div class="flex justify-start mb-4">
                        <div class="flex flex-col">
                            <div class="flex items-center">
                                <label for="diagramType" class="mr-2 text-gray-700">Diagram Type:</label>
                                <select id="diagramType" class="border border-gray-300 rounded-md px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="dfd">Data Flow Diagram (DFD)</option>
                                    <option value="er">Entity Relationship Diagram (ERD)</option>
                                    <option value="schema">Schema Diagram</option>
                                </select>
                            </div>
                            <div class="text-sm text-gray-500 italic mt-1">
                                Selected diagram type will be generated based on your description
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col items-center">
                    <textarea id="systemDescription"
                              class="chat-input w-full h-48 focus:outline-none"
                              placeholder="Enter your system description here... For example: 'A user management system that allows users to register, login, and update their profile information. The system stores user data in a database and sends email notifications for important events.'"></textarea>
                    <button onclick="generateDocumentation()"
                            class="generate-button mt-4 w-full flex items-center justify-center"
                            id="generateButton">
                        <i class="fas fa-magic mr-2"></i>
                        Generate <span id="generateButtonText">DFD</span>
                    </button>
                </div>
            </div>

            <!-- Output Section -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <!-- Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-8">
                        <button 
                            onclick="switchTab('flowchart')" 
                            class="tab-button active" 
                            id="flowchartTab"
                        >
                            <i class="fas fa-project-diagram mr-2"></i><span id="diagramTabText">Data Flow Diagram</span>
                        </button>
                        <button 
                            onclick="switchTab('documentation')" 
                            class="tab-button" 
                            id="documentationTab"
                        >
                            <i class="fas fa-file-alt mr-2"></i>Documentation
                        </button>
                        <button 
                            onclick="showDFDCode()" 
                            class="tab-button hidden" 
                            id="dfdCodeBtn"
                        >
                            <i class="fas fa-code mr-2"></i>DFD Code
                        </button>
                    </nav>
                </div>

                <!-- Flowchart Content -->
                <div id="flowchartContent" class="tab-content">
                    <div class="flex justify-end mb-4 space-x-2">
                        <button onclick="downloadDFD('svg')" class="text-blue-600 hover:text-blue-800" title="Download as SVG">
                            <i class="fas fa-file-image"></i> SVG
                        </button>
                        <button onclick="downloadDFD('png')" class="text-blue-600 hover:text-blue-800" title="Download as PNG">
                            <i class="fas fa-file-image"></i> PNG
                        </button>
                    </div>
                    <div id="dfdResult" class="preview-container">
                        <div class="preview-placeholder">Generated diagram will appear here</div>
                    </div>
                </div>

                <!-- Documentation Content -->
                <div id="documentationContent" class="tab-content hidden">
                    <div class="flex justify-end mb-4">
                        <button onclick="downloadDFDDoc('docx')" class="text-blue-600 hover:text-blue-800" title="Download as DOCX">
                            <i class="fas fa-file-word"></i> DOCX
                        </button>
                    </div>
                    <div id="dfdDocResult" class="preview-container">
                        <div class="preview-placeholder">Generated documentation will appear here</div>
                    </div>
                </div>

                <!-- DFD Code Content -->
                <div id="dfdCodeContent" class="tab-content hidden">
                    <div class="bg-white rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center p-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">DFD Code</h3>
                            <button onclick="copyDFDCode()" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <pre id="dfdCodeDisplay" class="p-4 bg-gray-50 overflow-auto max-h-96 text-sm font-mono"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Mermaid with all diagram types enabled
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            er: {
                useMaxWidth: true,
                titleTopMargin: 25,
                diagramPadding: 8
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            class: {
                useMaxWidth: true
            }
        });

        // Update generate button text based on selected diagram type
        document.getElementById('diagramType').addEventListener('change', function() {
            const diagramType = this.value;
            const buttonText = {
                'dfd': 'DFD',
                'er': 'ERD',
                'schema': 'Schema Diagram'
            }[diagramType];
            document.getElementById('generateButtonText').textContent = buttonText;
            
            // Update the tab text based on diagram type
            const tabText = {
                'dfd': 'Data Flow Diagram',
                'er': 'Entity Relationship Diagram',
                'schema': 'Schema Diagram'
            }[diagramType];
            document.getElementById('diagramTabText').textContent = tabText;

            // Show/hide DFD Code button based on diagram type
            const dfdCodeBtn = document.getElementById('showDFDCodeBtn');
            dfdCodeBtn.classList.toggle('hidden', diagramType !== 'dfd');

            // Show/hide DFD Code tab based on diagram type
            const dfdCodeTab = document.getElementById('dfdCodeTab');
            dfdCodeTab.classList.toggle('hidden', diagramType !== 'dfd');
        });

        function switchTab(tabName) {
            try {
                const tabs = {
                    'flowchart': {
                        tab: document.getElementById('flowchartTab'),
                        content: document.getElementById('flowchartContent')
                    },
                    'documentation': {
                        tab: document.getElementById('documentationTab'),
                        content: document.getElementById('documentationContent')
                    },
                    'dfdcode': {
                        tab: document.getElementById('dfdCodeBtn'),
                        content: document.getElementById('dfdCodeContent')
                    }
                };

                // Verify all elements exist
                if (!tabs[tabName]?.tab || !tabs[tabName]?.content) {
                    console.error(`Required elements for ${tabName} tab not found`);
                    return;
                }

                // Remove active class from all tabs and hide content
                Object.values(tabs).forEach(({ tab, content }) => {
                    if (tab && content) {
                        tab.classList.remove('active');
                        content.classList.add('hidden');
                    }
                });

                // Activate selected tab
                tabs[tabName].tab.classList.add('active');
                tabs[tabName].content.classList.remove('hidden');

                // If switching to documentation tab, update documentation content
                if (tabName === 'documentation') {
                    updateDocumentationContent();
                }
            } catch (error) {
                console.error('Error in switchTab:', error);
            }
        }

        function updateDocumentationContent() {
            try {
                const dfdDocResult = document.getElementById('dfdDocResult');
                if (!dfdDocResult) return;

                const diagramType = document.getElementById('diagramType').value;
                const docData = window.lastGeneratedData?.documentation || window.lastGeneratedData?.dfdDoc;

                if (!docData) {
                    dfdDocResult.innerHTML = '<div class="preview-placeholder">No documentation available. Please generate documentation first.</div>';
                    return;
                }

                let parsedDocData = docData;
                if (typeof docData === 'string') {
                    try {
                        parsedDocData = JSON.parse(docData);
                    } catch (error) {
                        console.error('Documentation parse error:', error);
                        dfdDocResult.innerHTML = '<div class="preview-placeholder">Error parsing documentation data.</div>';
                        return;
                    }
                }

                // Create HTML for the documentation based on diagram type
                let docHtml = '';
                switch(diagramType) {
                    case 'dfd':
                        docHtml = generateDFDDocHTML(parsedDocData);
                        break;
                    case 'er':
                        docHtml = generateERDocHTML(parsedDocData);
                        break;
                    case 'schema':
                        docHtml = generateSchemaDocHTML(parsedDocData);
                        break;
                    default:
                        docHtml = '<div class="preview-placeholder">Unknown diagram type</div>';
                }

                dfdDocResult.innerHTML = docHtml;
            } catch (error) {
                console.error('Error updating documentation:', error);
            }
        }

        // Add global variable to store the original mermaid code
        let lastGeneratedMermaidCode = '';

        function showErrorAlert(message) {
            const alertHTML = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" id="errorModal">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div class="mt-3 text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                            </div>
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Rendering Error</h3>
                            <div class="mt-2 px-7 py-3">
                                <p class="text-sm text-gray-500">${message}</p>
                            </div>
                            <div class="items-center px-4 py-3">
                                <button id="closeErrorModal" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = alertHTML;
            document.body.appendChild(modalDiv.firstChild);

            // Add close button handler
            document.getElementById('closeErrorModal').onclick = function() {
                document.getElementById('errorModal').remove();
            };
        }

        async function generateDocumentation() {
            const description = document.getElementById('systemDescription').value;
            const diagramType = document.getElementById('diagramType').value;
            
            if (!description) {
                showNotification('Please enter a system description', 'error');
                return;
            }

            try {
                showLoadingState(true);
                const response = await fetch('/api/generator/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        description,
                        diagramType 
                    }),
                });

                let data;
                try {
                    const rawText = await response.text();
                    data = JSON.parse(rawText);
                    window.lastGeneratedData = data;
                } catch (error) {
                    throw new Error(`Failed to process server response: ${error.message}`);
                }

                if (!response.ok) {
                    throw new Error(data.details || data.error || 'Failed to generate documentation');
                }
                
                // Update diagram
                const dfdResult = document.getElementById('dfdResult');
                if (!dfdResult) {
                    throw new Error('DFD result container not found');
                }
                
                let mermaidCode = data.diagram || data.dfd;
                if (typeof mermaidCode === 'string') {
                    mermaidCode = mermaidCode.replace(/```mermaid\n?/g, '').replace(/```/g, '').trim();
                    if (diagramType === 'dfd' && !mermaidCode.toLowerCase().includes('flowchart')) {
                        mermaidCode = 'flowchart TD\n' + mermaidCode;
                    }
                }

                // Store the original mermaid code
                lastGeneratedMermaidCode = mermaidCode;

                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                
                dfdResult.innerHTML = '';
                dfdResult.appendChild(mermaidDiv);

                let retryCount = 0;
                const maxRetries = 3;
                
                const tryRenderDiagram = async () => {
                    try {
                        await mermaid.init(undefined, '.mermaid');
                    } catch (error) {
                        retryCount++;
                        if (retryCount < maxRetries) {
                            showNotification(`Diagram rendering attempt ${retryCount} failed. Retrying...`, 'info');
                            await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds before retry
                            return tryRenderDiagram();
                        }
                        
                        console.error('Mermaid rendering error:', error);
                        showErrorAlert('Due to high system load, we are unable to render the diagram at this moment. Please try again after a few minutes.');
                        
                        dfdResult.innerHTML = `
                            <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                                <div class="text-red-600 font-semibold mb-2">Error rendering diagram</div>
                                <div class="text-sm text-gray-600 mb-4">The system is experiencing high load. Please try again in a few minutes.</div>
                                <button onclick="retryGeneration()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                    Retry Generation
                                </button>
                            </div>
                        `;
                        throw new Error('Failed to render diagram after multiple attempts');
                    }
                };

                await tryRenderDiagram();

                // Update DFD Code button visibility
                const dfdCodeBtn = document.getElementById('dfdCodeBtn');
                if (dfdCodeBtn) {
                    dfdCodeBtn.classList.toggle('hidden', diagramType !== 'dfd');
                }

                showNotification('Documentation generated successfully!', 'success');
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message || 'An error occurred while generating documentation', 'error');
            } finally {
                showLoadingState(false);
            }
        }

        function retryGeneration() {
            generateDocumentation();
        }

        function generateDFDDocHTML(dfdDoc) {
            return `
                <div class="doc-section">
                    <h4>System Overview</h4>
                    <div class="doc-item">${dfdDoc.systemOverview || 'No system overview available'}</div>
                </div>
                <div class="doc-section">
                    <h4>Level 2 DFD Description</h4>
                    <div class="doc-item">${dfdDoc.level2DFD || 'No Level 2 DFD description available'}</div>
                </div>
                <div class="doc-section">
                    <h4>External Entities</h4>
                    ${(dfdDoc.externalEntities || []).map(entity => `
                        <div class="doc-item">
                            <strong>${entity.name || 'Unnamed Entity'}</strong>
                            <p>${entity.description || 'No description available'}</p>
                            <p><em>Interactions:</em> ${entity.interactions || 'No interactions specified'}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="doc-section">
                    <h4>Processes</h4>
                    ${(dfdDoc.processes || []).map(process => `
                        <div class="doc-item">
                            <strong>${process.name || 'Unnamed Process'}</strong>
                            <p>${process.description || 'No description available'}</p>
                            <p><em>Inputs:</em> ${process.inputs || 'No inputs specified'}</p>
                            <p><em>Outputs:</em> ${process.outputs || 'No outputs specified'}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="doc-section">
                    <h4>Data Stores</h4>
                    ${(dfdDoc.dataStores || []).map(store => `
                        <div class="doc-item">
                            <strong>${store.name || 'Unnamed Data Store'}</strong>
                            <p>${store.description || 'No description available'}</p>
                            <p><em>Data:</em> ${store.data || 'No data specified'}</p>
                            <p><em>Access Patterns:</em> ${store.accessPatterns || 'No access patterns specified'}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="doc-section">
                    <h4>Data Flows</h4>
                    ${(dfdDoc.dataFlows || []).map(flow => `
                        <div class="doc-item">
                            <strong>${flow.from || 'Unknown'} → ${flow.to || 'Unknown'}</strong>
                            <p>${flow.description || 'No description available'}</p>
                            <p><em>Data:</em> ${flow.data || 'No data specified'}</p>
                            <p><em>Validations:</em> ${flow.validations || 'No validations specified'}</p>
                            <p><em>Transformations:</em> ${flow.transformations || 'No transformations specified'}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="doc-section">
                    <h4>System Boundaries</h4>
                    <div class="doc-item">${dfdDoc.systemBoundaries || 'No system boundaries specified'}</div>
                </div>
            `;
        }

        function generateERDocHTML(erDoc) {
            return `
                <div class="doc-section">
                    <h4>System Overview</h4>
                    <div class="doc-item">${erDoc.systemOverview || 'No system overview available'}</div>
                </div>
                <div class="doc-section">
                    <h4>Entities</h4>
                    ${(erDoc.entities || []).map(entity => `
                        <div class="doc-item">
                            <strong>${entity.name || 'Unnamed Entity'}</strong>
                            <p>${entity.description || 'No description available'}</p>
                            <p><em>Attributes:</em></p>
                            <ul class="list-disc ml-4">
                                ${(entity.attributes || []).map(attr => `
                                    <li>${attr.name} (${attr.type})${attr.isPrimary ? ' - Primary Key' : ''}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>
                <div class="doc-section">
                    <h4>Relationships</h4>
                    ${(erDoc.relationships || []).map(rel => `
                        <div class="doc-item">
                            <strong>${rel.from || 'Unknown'} ${rel.type || '→'} ${rel.to || 'Unknown'}</strong>
                            <p>${rel.description || 'No description available'}</p>
                            <p><em>Cardinality:</em> ${rel.cardinality || 'Not specified'}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateSchemaDocHTML(schemaDoc) {
            return `
                <div class="doc-section">
                    <h4>Database Overview</h4>
                    <div class="doc-item">${schemaDoc.databaseOverview || 'No database overview available'}</div>
                </div>
                <div class="doc-section">
                    <h4>Tables</h4>
                    ${(schemaDoc.tables || []).map(table => `
                        <div class="doc-item">
                            <strong>${table.name || 'Unnamed Table'}</strong>
                            <p>${table.description || 'No description available'}</p>
                            <p><em>Columns:</em></p>
                            <ul class="list-disc ml-4">
                                ${(table.columns || []).map(col => `
                                    <li>${col.name} (${col.type})${col.constraints ? ` - ${col.constraints}` : ''}</li>
                                `).join('')}
                            </ul>
                            ${table.primaryKey ? `<p><em>Primary Key:</em> ${table.primaryKey}</p>` : ''}
                            ${(table.foreignKeys || []).length > 0 ? `
                                <p><em>Foreign Keys:</em></p>
                                <ul class="list-disc ml-4">
                                    ${table.foreignKeys.map(fk => `
                                        <li>${fk.column} references ${fk.references}</li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg ${
                type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-500' : 'bg-green-500'
            } text-white z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        function showLoadingState(isLoading) {
            const button = document.getElementById('generateButton');
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
            } else {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-magic mr-2"></i>Generate <span id="generateButtonText">DFD</span>';
            }
        }

        async function downloadDFD(format) {
            const svg = document.querySelector('.mermaid svg');
            if (!svg) {
                showNotification('No diagram available to download. Please generate the documentation first.', 'error');
                return;
            }

            try {
                // Clone the SVG for export to avoid modifying the displayed version
                const clonedSvg = svg.cloneNode(true);
                const bbox = svg.getBBox();
                const svgWidth = Math.max(bbox.width, svg.viewBox.baseVal.width || svg.width.baseVal.value);
                const svgHeight = Math.max(bbox.height, svg.viewBox.baseVal.height || svg.height.baseVal.value);
                
                // Add padding to ensure no content is cut off
                const padding = 20;
                const totalWidth = svgWidth + (padding * 2);
                const totalHeight = svgHeight + (padding * 2);
                
                // Scale factor for better quality (2x for retina displays)
                const scale = 2;

                // Update cloned SVG attributes for export
                clonedSvg.setAttribute('width', totalWidth);
                clonedSvg.setAttribute('height', totalHeight);
                clonedSvg.setAttribute('viewBox', `${bbox.x - padding} ${bbox.y - padding} ${totalWidth} ${totalHeight}`);

                const svgData = new XMLSerializer().serializeToString(clonedSvg);
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });

                if (format === 'svg') {
                    saveAs(svgBlob, 'dfd-diagram.svg');
                } else if (format === 'png') {
                    const img = new Image();
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Convert SVG to base64 for reliable loading
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.onload = function() {
                            try {
                                // Set canvas size to match total SVG dimensions with scaling
                                canvas.width = totalWidth * scale;
                                canvas.height = totalHeight * scale;
                                
                                // Set white background
                                ctx.fillStyle = 'white';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                
                                // Scale the context for better quality
                                ctx.scale(scale, scale);
                                
                                // Draw the image with padding
                                ctx.drawImage(img, 0, 0, totalWidth, totalHeight);
                                
                                // Convert to PNG with high quality
                                canvas.toBlob(function(blob) {
                                    if (blob) {
                                        saveAs(blob, 'dfd-diagram.png');
                                    } else {
                                        throw new Error('Failed to create PNG blob');
                                    }
                                }, 'image/png', 1.0);
                            } catch (error) {
                                console.error('Error creating PNG:', error);
                                showNotification('Error creating PNG: ' + error.message, 'error');
                            }
                        };

                        img.onerror = function() {
                            console.error('Error loading image');
                            showNotification('Error loading image for PNG conversion', 'error');
                        };

                        img.src = e.target.result;
                    };

                    reader.onerror = function() {
                        console.error('Error reading SVG data');
                        showNotification('Error reading SVG data', 'error');
                    };

                    reader.readAsDataURL(svgBlob);
                }
            } catch (error) {
                console.error('Error in downloadDFD:', error);
                showNotification('Error downloading diagram: ' + error.message, 'error');
            }
        }

        async function downloadDFDDoc(format) {
            const fullScreenLoader = document.getElementById('fullScreenLoader');
            const downloadButton = document.querySelector('button[onclick="downloadDFDDoc(\'docx\')"]');
            
            try {
                // Show loader and disable button
                fullScreenLoader.style.display = 'flex';
                downloadButton.disabled = true;
                
                const response = await fetch('/api/generator/download-docx', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        description: document.getElementById('systemDescription').value,
                        diagramType: document.getElementById('diagramType').value
                    }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate documentation');
                }

                // Get the blob from the response
                const blob = await response.blob();
                
                // Save the file
                saveAs(blob, 'dfd-documentation.docx');
                showNotification('Documentation downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error creating DOCX:', error);
                showNotification(`Error creating DOCX file: ${error.message}`, 'error');
            } finally {
                // Hide loader and enable button
                fullScreenLoader.style.display = 'none';
                downloadButton.disabled = false;
            }
        }

        function showDFDCode() {
            try {
                if (!lastGeneratedMermaidCode) {
                    showNotification('Please generate a DFD diagram first', 'error');
                    return;
                }

                const dfdCodeDisplay = document.getElementById('dfdCodeDisplay');
                if (dfdCodeDisplay) {
                    // Format the stored mermaid code
                    const formattedCode = formatDFDCode(lastGeneratedMermaidCode);
                    dfdCodeDisplay.textContent = formattedCode;
                }

                // Switch to DFD code tab
                switchTab('dfdcode');
            } catch (error) {
                console.error('Error in showDFDCode:', error);
                showNotification('Error showing DFD code', 'error');
            }
        }

        function formatDFDCode(code) {
            try {
                // Split into lines and clean them
                let lines = code.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);

                // Ensure we have a header
                const headerIndex = lines.findIndex(line => 
                    line.toLowerCase().includes('flowchart') || 
                    line.toLowerCase().includes('graph'));

                if (headerIndex === -1) {
                    lines.unshift('flowchart TD');
                } else {
                    // Move header to the beginning if it's not already there
                    if (headerIndex > 0) {
                        const header = lines.splice(headerIndex, 1)[0];
                        lines.unshift(header);
                    }
                }

                // Group connections by source node
                const groups = new Map();
                let currentNode = null;

                lines.slice(1).forEach(line => { // Skip header
                    if (line.includes('-->')) {
                        const [source] = line.split('-->').map(part => part.trim());
                        if (!groups.has(source)) {
                            groups.set(source, []);
                            currentNode = source;
                        }
                        groups.get(currentNode).push(line);
                    }
                });

                // Format the output
                let formattedLines = [lines[0]]; // Start with header

                groups.forEach((connections, source) => {
                    if (formattedLines.length > 1) {
                        formattedLines.push(''); // Add blank line between groups
                    }
                    connections.forEach(conn => {
                        formattedLines.push(conn.endsWith(';') ? conn : conn + ';');
                    });
                });

                return formattedLines.join('\n');
            } catch (error) {
                console.error('Error formatting DFD code:', error);
                return code;
            }
        }

        function copyDFDCode() {
            const codeDisplay = document.getElementById('dfdCodeDisplay');
            if (codeDisplay) {
                navigator.clipboard.writeText(codeDisplay.textContent).then(() => {
                    showNotification('DFD code copied to clipboard!', 'success');
                }).catch(() => {
                    showNotification('Failed to copy code to clipboard', 'error');
                });
            }
        }

        // Close modal when clicking outside
        document.getElementById('dfdCodeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideDFDCode();
            }
        });
    </script>
</body>
</html> 